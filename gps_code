#include <TinyGPSPlus.h>
#include <HardwareSerial.h>

// GPS object
TinyGPSPlus gps;

// HardwareSerial for GPS
HardwareSerial GPS_Serial(2);

// GPS pins
#define RXD2 16  // GPS TX → ESP32 RX
#define TXD2 17  // GPS RX → ESP32 TX
#define GPS_BAUD 9600

void setup() {
  Serial.begin(115200);                // Serial monitor for debug
  GPS_Serial.begin(GPS_BAUD, SERIAL_8N1, RXD2, TXD2);

  Serial.println("=== GPS Tracker Started ===");
  Serial.println("Waiting for GPS fix...");
}

void loop() {
  // Feed GPS data to TinyGPSPlus
  while (GPS_Serial.available() > 0) {
    char c = GPS_Serial.read();
    gps.encode(c);
  }

  static unsigned long lastPrint = 0;
  if (millis() - lastPrint > 1000) {  // Update every 1 second
    lastPrint = millis();

    if (gps.location.isValid()) {
      // GPS fix obtained
      Serial.println("\n=== Real-Time GPS Data ===");
      Serial.print("Latitude: "); Serial.println(gps.location.lat(), 6);
      Serial.print("Longitude: "); Serial.println(gps.location.lng(), 6);

      // Print HDOP (accuracy)
      if (gps.hdop.isValid()) {
        Serial.print("HDOP: ");
        Serial.println(gps.hdop.value());
      } else {
        Serial.println("HDOP: Not valid yet");
      }

      // Print IST time
      if (gps.time.isValid()) {
          int hourIST = gps.time.hour() + 5;
          int minuteIST = gps.time.minute() + 30;
          int secondIST = gps.time.second();

          // Handle minute overflow
          if (minuteIST >= 60) {
              minuteIST -= 60;
              hourIST += 1;
          }

          // Handle hour overflow
          if (hourIST >= 24) {
              hourIST -= 24;
          }

          Serial.print("Time (IST): ");
          if (hourIST < 10) Serial.print("0");
          Serial.print(hourIST); Serial.print(":");
          if (minuteIST < 10) Serial.print("0");
          Serial.print(minuteIST); Serial.print(":");
          if (secondIST < 10) Serial.print("0");
          Serial.println(secondIST);
      } else {
          Serial.println("Time (IST): Not valid yet");
      }

      // Satellites info
      Serial.print("Satellites: ");
      if (gps.satellites.isValid()) Serial.println(gps.satellites.value());
      else Serial.println("Not valid yet");

      Serial.println("==========================");
    } else {
      // No GPS fix yet
      Serial.println("Waiting for GPS fix...");
    }
  }
}
